using System.Linq;
using Content.Shared.Administration;
using JetBrains.Annotations;
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.IoC;
using Robust.Shared.Utility;
using static Robust.Client.UserInterface.Controls.LineEdit;

namespace Content.Client.Administration.UI.Tabs.AdminTab
{
    [GenerateTypedNameReferences]
    [UsedImplicitly]
    public sealed partial class JobBanWindow : DefaultWindow
    {
        private HashSet<CheckBox> _jobs = new() { };
        public JobBanWindow()
        {
            RobustXamlLoader.Load(this);
            _jobs.Add(Captain);
            _jobs.Add(HeadOfPersonnel);
            _jobs.Add(HeadOfSecurity);
            _jobs.Add(ChiefMedicalOfficer);
            _jobs.Add(ChiefEngineer);
            _jobs.Add(ResearchDirector);
            _jobs.Add(Quartermaster);
            _jobs.Add(Warden);
            _jobs.Add(SecurityOfficer);
            _jobs.Add(Detective);
            _jobs.Add(SecurityCadet);
            _jobs.Add(Chemist);
            _jobs.Add(MedicalDoctor);
            _jobs.Add(Psychologist);
            _jobs.Add(MedicalIntern);
            _jobs.Add(AtmosphericTechnician);
            _jobs.Add(StationEngineer);
            _jobs.Add(TechnicalAssistant);
            _jobs.Add(CargoTechnician);
            _jobs.Add(SalvageSpecialist);
            _jobs.Add(Scientist);
            _jobs.Add(Lawyer);
            _jobs.Add(ServiceWorker);
            _jobs.Add(Botanist);
            _jobs.Add(Chef);
            _jobs.Add(Bartender);
            _jobs.Add(Janitor);
            _jobs.Add(Clown);
            _jobs.Add(Mime);
            _jobs.Add(Librarian);
            _jobs.Add(Musician);
            _jobs.Add(Chaplain);
            _jobs.Add(Zookeeper);
            PlayerNameLine.OnTextChanged += _ =>
            {
                OnPlayerNameChanged();
                OnJobNameChanged();
            };
            JobNameLine.OnTextChanged += _ =>
            {
                OnPlayerNameChanged();
                OnJobNameChanged();
            };
            PlayerList.OnSelectionChanged += OnPlayerSelectionChanged;
            SubmitButtonByName.OnPressed += SubmitButtonByNameOnPressed;
            SubmitButtonList.OnPressed += SubmitButtonListOnPressed;
            MinutesLine.OnTextChanged += UpdateButtonsText;
            HourButton.OnPressed += _ => AddMinutes(60);
            DayButton.OnPressed += _ => AddMinutes(1440);
            WeekButton.OnPressed += _ => AddMinutes(10080);
            MonthButton.OnPressed += _ => AddMinutes(43200);
            OnPlayerNameChanged();
            OnJobNameChanged();
        }
        private bool TryGetMinutes(string str, out uint minutes)
        {
            if (string.IsNullOrWhiteSpace(str))
            {
                minutes = 0;
                return true;
            }

            return uint.TryParse(str, out minutes);
        }

        private void AddMinutes(uint add)
        {
            if (!TryGetMinutes(MinutesLine.Text, out var minutes))
                return;

            MinutesLine.Text = $"{minutes + add}";
            UpdateButtons(minutes + add);
        }

        private void UpdateButtonsText(LineEditEventArgs obj)
        {
            if (!TryGetMinutes(obj.Text, out var minutes))
                return;
            UpdateButtons(minutes);
        }

        private void UpdateButtons(uint minutes)
        {
            HourButton.Text = $"+1h ({minutes / 60})";
            DayButton.Text = $"+1d ({minutes / 1440})";
            WeekButton.Text = $"+1w ({minutes / 10080})";
            MonthButton.Text = $"+1M ({minutes / 43200})";
        }

        private void OnPlayerNameChanged()
        {
            SubmitButtonByName.Disabled = string.IsNullOrEmpty(PlayerNameLine.Text);
            SubmitButtonList.Disabled = string.IsNullOrEmpty(PlayerNameLine.Text);
        }

        private void OnJobNameChanged()
        {
            SubmitButtonByName.Disabled = string.IsNullOrEmpty(JobNameLine.Text);
        }

        public void OnPlayerSelectionChanged(PlayerInfo? player)
        {
            PlayerNameLine.Text = player?.Username ?? string.Empty;
            OnPlayerNameChanged();
            OnJobNameChanged();
        }

        private void SubmitButtonByNameOnPressed(BaseButton.ButtonEventArgs obj)
        {
            // Small verification if Player Name exists
            IoCManager.Resolve<IClientConsoleHost>().ExecuteCommand(
                $"roleban \"{PlayerNameLine.Text}\" \"{JobNameLine.Text}\" \"{CommandParsing.Escape(ReasonLine.Text)}\" {MinutesLine.Text}");
        }

        private void SubmitButtonListOnPressed(BaseButton.ButtonEventArgs obj)
        {
            foreach (var job in _jobs.Where(job => job.Pressed))
            {
                IoCManager.Resolve<IClientConsoleHost>().ExecuteCommand($"roleban \"{PlayerNameLine.Text}\" \"{job.Name}\" \"{CommandParsing.Escape(ReasonLine.Text)}\" {MinutesLine.Text}");
                job.Pressed = false;
            }
        }
    }
}
